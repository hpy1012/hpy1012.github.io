<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android--Handle | Radio2Chef&#39;s Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="What’s “Handle”?Handle is a mechanism about updating UI, also can processing message.ex:All Activities’s life cycly callback through it.According to diffrerent message,do the corresponding branch proc">
<meta property="og:type" content="article">
<meta property="og:title" content="Android--Handle">
<meta property="og:url" content="hpy1012.com/2015/11/23/Android--Handle/index.html">
<meta property="og:site_name" content="Radio2Chef's Profile">
<meta property="og:description" content="What’s “Handle”?Handle is a mechanism about updating UI, also can processing message.ex:All Activities’s life cycly callback through it.According to diffrerent message,do the corresponding branch proc">
<meta property="og:updated_time" content="2016-11-23T09:27:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android--Handle">
<meta name="twitter:description" content="What’s “Handle”?Handle is a mechanism about updating UI, also can processing message.ex:All Activities’s life cycly callback through it.According to diffrerent message,do the corresponding branch proc">
  
    <link rel="alternate" href="/atom.xml" title="Radio2Chef&#39;s Profile" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Radio2Chef&#39;s Profile</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Zoeken"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="hpy1012.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Android--Handle" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/23/Android--Handle/" class="article-date">
  <time datetime="2015-11-23T01:36:04.000Z" itemprop="datePublished">2015-11-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android--Handle
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="What’s-“Handle”"><a href="#What’s-“Handle”" class="headerlink" title="What’s “Handle”?"></a>What’s “Handle”?</h5><p>Handle is a <strong>mechanism</strong> about updating UI, also can processing message.ex:All Activities’s life cycly callback through it.According to diffrerent message,do the corresponding branch processing.<br>As Android Documents:<br><strong>There are two main uses for a Handler:(1) to schedule messages and runnables to be executed as some point in the future; and (2) to enqueue an action to be performed on a different thread than your own.</strong></p>
<h5 id="Why-should-we-use-it"><a href="#Why-should-we-use-it" class="headerlink" title="Why should we use it?"></a>Why should we use it?</h5><p>Because Android generally updates UI in the mainthread,however in the real world, we need to access UI in sub thread.</p>
<h5 id="Principle-of-Message-mechanism"><a href="#Principle-of-Message-mechanism" class="headerlink" title="Principle of Message mechanism"></a>Principle of Message mechanism</h5><p>Message mechanism inculds 3 department</p>
<p><strong>-Looper:</strong></p>
<p>Class used to run a message loop for a thread. Threads by default do not have a message loop associated with them; to create one, call prepare() in the thread that is to run the loop, and then loop() to have it process messages until the loop is stopped.<br><strong>About mainthread,a Looper has been created automatically. We can get the Looper by</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Looper <span class="title">getMainLooper</span><span class="params">()</span></span></div></pre></td></tr></table></figure></p>
<p>Typical example of the implementation of a Looper thread, using the separation of <code>prepare()</code> and <code>loop()</code> to create an initial Handler to communicate with the Looper.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> Handler mHandler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        Looper.prepare();</div><div class="line"></div><div class="line">        mHandler = <span class="keyword">new</span> Handler() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">                <span class="comment">// process incoming messages here</span></div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        Looper.loop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>-Message Queue:</strong></p>
<p>Low-level class holding the list of messages to be dispatched by a Looper. Messages are not added directly to a MessageQueue, but rather through Handler objects associated with the Looper.</p>
<p>You can retrieve the MessageQueue for the current thread with Looper.myQueue().<br><em>MessageQueue myQueue ()<br>Return the MessageQueue object associated with the current thread. This must be called from a thread running a Looper, or a NullPointerException will be thrown.</em></p>
<p><strong>-Handle:</strong></p>
<p>Handler can send and receive messages:</p>
<pre><code>boolean sendMessage (Message msg)
</code></pre><p>Pushes a message onto the end of the message queue after all pending messages before the current time. It will be received in <strong>handleMessage(Message)</strong>, in the thread attached to this handler</p>
<pre><code>boolean sendMessageDelayed (Message msg, long delayMillis)
</code></pre><p>Enqueue a message into the message queue after all pending messages before (current time + delayMillis). You will receive it in <strong>handleMessage(Message)</strong>, in the thread attached to this handler.</p>
<pre><code>boolean post (Runnable r)
</code></pre><p>Causes the Runnable r to be added to the message queue. The runnable will be run on the thread to which this handler is attached.</p>
<pre><code>boolean postDelayed (Runnable r, long delayMillis)
</code></pre><p>Causes the Runnable r to be added to the message queue, to be run after the specified amount of time elapses. The runnable will be run on the thread to which this handler is attached. The time-base is uptimeMillis(). Time spent in deep sleep will add an additional delay to execution.</p>
<p>Above two methods of “post” are actually using “send Method”.look this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Causes the Runnable r to be added to the message queue.</div><div class="line">   * The runnable will be run on the thread to which this handler is </div><div class="line">   * attached. </div><div class="line">   *  </div><div class="line">   * <span class="doctag">@param</span> r The Runnable that will be executed.</div><div class="line">   * </div><div class="line">   * <span class="doctag">@return</span> Returns true if the Runnable was successfully placed in to the </div><div class="line">   *         message queue.  Returns false on failure, usually because the</div><div class="line">   *         looper processing the message queue is exiting.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">post</span><span class="params">(Runnable r)</span></span></div><div class="line">  &#123;</div><div class="line">     <span class="keyword">return</span>  sendMessageDelayed(getPostMessage(r), <span class="number">0</span>);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>Receive message:</p>
<pre><code>void handleMessage (Message msg)
</code></pre><p>Subclasses must implement this to receive messages.</p>
<p>####Supplement:####</p>
<p><strong>When was the MessageQueue created？</strong><br>Looper created at <code>Looper.prepare()</code>(mainthread automatically create it.)<br>Handler create by yourself.</p>
<p>When was the MessageQueue create?</p>
<p>In Looper’s construction method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">    mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);</div><div class="line">    mThread = Thread.currentThread();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>There is a new MessageQueue object.We can understand that a thread corresponding a MessageQueue. Each of MessafeQueue can’t exist without Looper.</p>
<p><strong>What role does ThreadLocal play in Handle?</strong><br>Look this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</div><div class="line">       &#125;</div><div class="line">       sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>sThreadLocal is a ThreadLocal object,it can store variables in a thread. After variables stored, only can obtain them in the specified thread.</p>
<p><strong>Looper,Handler,MessageQueue ‘s reference relationship</strong></p>
<p>A Handler be sure hold corresponding MessageQueue and Looper.<br>A thread have only one Looper and  MessageQueue at most.<br>A thread can have a number of Handler.</p>
<p><strong> Handler leads to memory leak </strong></p>
<p>Generally write Handler:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">	Handler mHandler = <span class="keyword">new</span> Handler()&#123;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerMessage</span><span class="params">(Message msg)</span></span>&#123;</div><div class="line">	mImageView.setImageBitmap(mBitmap);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Above codes maybe leads to memory leak! Because Handler object will implicitly hold a external class(generally is a activity) reference when we use the internal class to create Handler, but rather there are some Messages haven’t been processed yet after exit Acitivity that leads to memory leak.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="hpy1012.com/2015/11/23/Android--Handle/" data-id="cj9p5gpd60003lw8zw9mv5lc1" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/11/28/Tips-valueOf-paresDouble/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Nieuwer</strong>
      <div class="article-nav-title">
        
          Tips - valueOf() &amp; paresXxx()
        
      </div>
    </a>
  
  
    <a href="/2015/11/18/BubbleSort/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ouder</strong>
      <div class="article-nav-title">BubbleSort</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Labels</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithm/">Algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Life/">Life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PM/">PM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Programming/">Programming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tips/">Tips</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Writing/">Writing</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Algorithm/" style="font-size: 17.5px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Life/" style="font-size: 10px;">Life</a> <a href="/tags/PM/" style="font-size: 10px;">PM</a> <a href="/tags/Programming/" style="font-size: 10px;">Programming</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/Tips/" style="font-size: 12.5px;">Tips</a> <a href="/tags/Writing/" style="font-size: 10px;">Writing</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archieven</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recente berichten</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/06/23/Python备忘录-切片/">Python备忘录 -- 切片</a>
          </li>
        
          <li>
            <a href="/2017/05/19/产品经理数据分析入门（转自简书）/">产品经理数据分析入门（转自简书）</a>
          </li>
        
          <li>
            <a href="/2017/05/03/产品实习/">产品实习</a>
          </li>
        
          <li>
            <a href="/2017/03/24/每天一道题（入门篇）-经典二分查找/">每天一道题（入门篇）--经典二分查找</a>
          </li>
        
          <li>
            <a href="/2017/03/24/每天一道题（入门篇）-冒泡排序/">每天一道题（入门篇）--冒泡排序</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Radio2Chef<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>